clc; close all; clear;

% Inputs
Pc = 400; % psi
Pa = 12.7;
OF = 1.5:0.05:3.5;

A_e = (pi*6.5^2/4)*0.0254^2; % m^2 (do not change)
T = 5000/3 * 4.448; % N

C_star_eff = 0.9;
C_F_eff = 0.95;

D_e = 4.1;
A_e = (pi*D_e.^2/4)*0.0254^2;
% Setup
for i=1:length(OF)
    mdot_old = 0;
    if i ==1
    mdot(i) = 1;
    else
    mdot(i) = mdot(i-1);
    end
    A_t = 1e-3;
    
    tol = 1e-5;
    err = 1;
    while abs(err)>tol
    
        data = CEA('problem','rocket','equilibrium','fac','ma,kg/s',mdot(i),'o/f',OF(i),'p(psi)',Pc+Pa,'supsonic(ae/at)',A_e/A_t,'reactants','fuel','RP-1','wt%',100,'t(k)',298.15,'oxid','O2(L)','wt%',100,'t(k)',90.0,'output','transport','mks','end');
        C_star = data.output.eql.cstar(1);
        C_F = data.output.eql.cf(end);
        isp(i) = data.output.eql.isp(end);
        mdot(i) = T/(C_star*C_star_eff*C_F*C_F_eff);
        A_t = C_star*C_star_eff*mdot(i)/((Pc+Pa)*6894.7);
        err = mdot_old-mdot(i);
        mdot_old = mdot(i);
        if A_e<A_t
            mdot(i) = NaN;
            break
        end
    end
    clc
    fprintf('%.0f%%\n',i/length(OF)*100)
end

% Isp_exp = [289.690452004886	290.372214538844	291.034860954095	291.679313342313	292.306431375313	292.917017723921	293.511822910457	294.091549656178	294.656856789119	295.208362763369	295.746648834897	296.272261933478	296.785717264483	297.287500670551	297.778070779106	298.257860958393	298.727281102282	299.186719213789	299.636543113774	300.077101433699	300.508725172758	300.931728756322	301.346411100529	301.753056593201	302.151935998763	302.543307294420	302.927416443705	303.304498112894	303.674776335396	304.038465128368	304.395769066085	304.746883812958	305.091996620288	305.431286788936	305.764926101267	306.093079224523	306.415904087723	306.733552234358	307.046169152593	307.353894584846	307.656862768139	307.955202928375	308.249039159042	308.538490953675	308.823673343554	309.104697111438	309.381668992323	309.654691862944	309.923864920323	310.189283850159	310.451040985953	310.709225459214	310.963923341650	311.215217779571	311.463189121085	311.707915036675	311.949470633454	312.187928563447	312.423359126396	312.655830367182	312.885408168590	313.112156339212	313.336136697208	313.557409149724	313.776031768771	313.992060863129	314.205551047126	314.416555259924	314.625125031257	314.831310865888	315.035159875479	315.236719810250	315.436036390111	315.633154038790	315.828115931229	316.020964038752	316.211739172225	316.400481023236	316.587228203685	316.772018283379	316.954887826330	317.135872425277	317.315006734889	317.492324503544	317.667858603826	317.841641061770	318.013703084862	318.184075088959	318.352786724246	318.519866899879	318.685343807939	318.849244946304	319.011597140654	319.172426524651	319.331758736140	319.489618651963	319.646031513083	319.801019258142	319.954606027545	320.106814491720	320.257666797029]';
% Isp = [214.4599427	217.1668316	219.6932911	222.0635232	224.2971723	226.4099891	228.4150813	230.323013	232.1431391	233.8833179	235.550337	237.1502541	238.6879361	240.1681404	241.594933	242.9719452	244.3024352	245.5893395	246.8353155	248.0427765	249.2140649	250.3508884	251.455254	252.5288569	253.5732594	254.5899057	255.5801329	256.5451822	257.4862079	258.4042855	259.3004187	260.1755462	261.0305468	261.866245	262.6834151	263.4829261	264.2651707	265.0309497	265.7808737	266.5155202	267.2354353	267.9411369	268.6352987	269.3139778	269.9798455	270.6333229	271.2748106	271.9046904	272.5233263	273.1310657	273.7282403	274.3151672	274.8921495	275.4594776	276.0174293	276.5662709	277.1062579	277.6376354	278.1606385	278.6754932	279.1825439	279.6817369	280.1734092	280.6577542	281.1349583	281.605201	282.0686553	282.5254882	282.9758606	283.4199282	283.8578409	284.2897422	284.7157757	285.1360751	285.550817	285.9600368	286.3639029	286.7625349	287.1560475	287.5445522	287.9281572	288.3069672	288.681084	289.050606	289.4156291	289.7762459	290.1326678	290.4847275	290.8326423	291.1764994	291.5163762	291.8523488	292.1828114	292.511202	292.8359146	293.1570168	293.4745766	293.7887515	294.0993646	294.4066314	294.7106131;
% 236.4544852	238.3800984	240.2163556	241.9711804	243.6513206	245.262688	246.8104958	248.2993674	249.7335719	251.1164881	252.4516105	253.7419405	254.9901997	256.1988645	257.3701952	258.5062611	259.6089618	260.6800458	261.7211258	262.7336936	263.7191314	264.6787227	265.6137938	266.5251807	267.4140689	268.2814298	269.1281737	269.9551543	270.7631739	271.5529869	272.325304	273.0807956	273.8200946	274.5437992	275.2524756	275.9486758	276.6288502	277.2955268	277.9491641	278.5901983	279.2190446	279.8360983	280.4417365	281.036319	281.6201892	282.1936753	282.7572123	283.3108501	283.8550043	284.3899539	284.915961	285.433279	285.94215	286.4410131	286.9336842	287.4185818	287.8959133	288.3658783	288.8286691	289.2844706	289.7334614	290.1758133	290.6116923	291.0412583	291.4646659	291.8820641	292.2935972	292.6994042	293.0996178	293.4943724	293.8837917	294.2680407	294.6471505	295.0212791	295.3905371	295.7550318	296.1149841	296.4702512	296.8210577	297.1674985	297.5096654	297.8476476	298.1815319	298.5114024	298.8373407	299.1594264	299.4777364	299.792346	300.1033279	300.4107532	300.7146901	301.0152072	301.3124727	301.6063051	301.8969093	302.1842971	302.4686724	302.7499471	303.0282253	303.3036925	303.5761675;
% 251.4835922	253.0778369	254.6085477	256.0802823	257.4971171	258.8627141	260.1803763	261.4530936	262.6835823	263.8743178	265.0275626	266.1453905	267.2298326	268.2823813	269.304798	270.2985828	271.265127	272.2057236	273.121576	274.0138066	274.883464	275.7315292	276.5589214	277.3665035	278.1550861	278.9254323	279.6782598	280.4142488	281.1340387	281.838235	282.5274109	283.2021094	283.8628456	284.5101085	285.1444822	285.7661592	286.3756923	286.97348	287.5599042	288.1353293	288.7001029	289.2545574	289.7990105	290.333766	290.8591149	291.3753359	291.8826959	292.3814512	292.8718475	293.3541185	293.8284953	294.2951932	294.7544217	295.2063821	295.6512682	296.0892667	296.5205571	296.9453128	297.3637007	297.7758816	298.1820111	298.582239	298.97671	299.3655639	299.7489359	300.1269564	300.4997518	300.867553	301.2302939	301.5881228	301.941192	302.2896087	302.6334768	302.9728967	303.307966	303.6387792	303.9654279	304.288001	304.6065848	304.9212631	305.2321171	305.5392257	305.8426656	306.1425113	306.4388352	306.7317076	307.0211969	307.3073695	307.590385	307.8700911	308.1466704	308.4201826	308.6906657	308.9582357	309.2228881	309.4846961	309.7437121	309.9999867	310.2536902	310.5046468	310.7530063;
% 260.9037759	262.3352895	263.7134288	265.0416965	266.3232567	267.561111	268.7576007	269.9152594	271.0362733	272.1226491	273.1762344	274.1987336	275.1917226	276.1566619	277.0949075	278.0077206	278.8962769	279.7616736	280.6049368	281.4270271	282.2288459	283.0112393	283.7750033	284.5208871	285.2495974	285.9617993	286.6582443	287.3392823	288.0056049	288.6577469	289.2962159	289.9214938	290.5340385	291.1342857	291.7226502	292.2995271	292.865293	293.4203075	293.9649116	294.4994374	295.0241963	295.5394878	296.0455992	296.5428053	297.0313695	297.5115443	297.983572	298.4476853	298.9041074	299.3530529	299.7947281	300.2293312	300.6570532	301.0780776	301.4925814	301.900735	302.3027024	302.6986421	303.0887067	303.4730435	303.8518998	304.225196	304.5931768	304.9559704	305.3137005	305.6664868	306.0144451	306.3577267	306.6963609	307.0304926	307.3602232	307.6856513	308.0068722	308.3239783	308.6370592	308.9462019	309.2514906	309.5530072	309.8508308	310.1450387	310.4357055	310.722904	311.0067047	311.2871762	311.5643851	311.8384867	312.1093433	312.3771271	312.6418978	312.9037132	313.1625586	313.4187023	313.6719843	313.9225278	314.1703836	314.4156009	314.6582279	314.8983114	315.1360102	315.3711535	315.6038876;
% 270.5985598	271.8864405	273.1286596	274.3280008	275.4870023	276.6079858	277.69308	278.7442421	279.763276	280.7518479	281.7115002	282.6436635	283.5496676	284.4307504	285.2880649	286.1226933	286.935643	287.7279817	288.5003436	289.2536947	289.9888196	290.7064572	291.4073042	292.0920187	292.7612225	293.4155037	294.0554176	294.6814965	295.2942391	295.8941211	296.4815948	297.05709	297.621016	298.1737628	298.7157019	299.2471878	299.7685588	300.2801381	300.7822345	301.2751434	301.7591473	302.2345167	302.701511	303.1603783	303.611357	304.0546754	304.4905531	304.9192005	305.3408202	305.7556065	306.1637467	306.5655271	306.9609016	307.3501504	307.7334339	308.110907	308.4827189	308.8490136	309.2099299	309.5656018	309.9161585	310.2617252	310.6024224	310.9383668	311.2696712	311.5964817	311.918829	312.2368528	312.550652	312.8603221	313.1659559	313.467643	313.7654705	314.0595225	314.349881	314.636624	314.9198306	315.1995743	315.4759276	315.7489607	316.018742	316.2854304	316.5488899	316.8092914	317.0666958	317.3211623	317.5727483	317.8215097	318.0674886	318.3107752	318.5513837	318.7893768	319.0248032	319.2577105	319.4881452	319.7161522	319.9417756	320.1650582	320.386139	320.6048722	320.8213866;
% 278.659087	279.8406869	280.9816047	282.0842076	283.1506661	284.1829755	285.1829726	286.152359	287.0927045	288.0054666	288.8921201	289.7536745	290.5914367	291.4065045	292.1999044	292.9725981	293.7254876	294.4594181	295.1751906	295.8735528	296.5552117	297.2208345	297.8710513	298.5064578	299.127618	299.7350658	300.3293078	300.9108244	301.480072	302.0374842	302.5834736	303.1184328	303.6427357	304.1567388	304.6607822	305.1551902	305.6402727	306.1163259	306.5836328	307.0424642	307.4930794	307.9357267	308.3706439	308.7981651	309.2182908	309.6313436	310.0375249	310.4370284	310.83004	311.2167386	311.5972963	311.9718784	312.3406445	312.7037478	313.0613362	313.4135521	313.760532	314.1024102	314.4393137	314.7713657	315.0986854	315.4213877	315.7395839	316.0534169	316.3629189	316.6682265	316.9694369	317.266644	317.5599389	317.8494098	318.1351419	318.4172181	318.6957184	318.9707206	319.2422999	319.5105296	319.7754804	320.0373159	320.2959013	320.5514087	320.8039011	321.0534397	321.3000838	321.5438912	321.7849179	322.0232187	322.2588644	322.4917649	322.7222872	322.9502002	323.1756385	323.3986484	323.619275	323.8375623	324.0535529	324.2672881	324.4788095	324.6881562	324.8953668	325.100479	325.3035294];

figure(1)
plot(OF,isp,'LineWidth',2)
xlabel('O/F Ratio')
ylabel('Specific Impulse (s)')
grid on
% 
% close
% figure(2)
% hold on
% plot(Pc,Isp*0.9*0.95,'LineWidth',2)
% plot(Pc,(Isp_exp)*1.5-190,'k','LineWidth',2,'LineStyle','--')
% hold off
% xlabel('Pc (psi)')
% ylabel('Specific Impulse (m/s)')
% legend('4.1in','4.6in','5.1in','5.5in','6.0in','6.5in','Ideal')
% title('Specific Impulse vs Chamber Pressure')
% grid on
% 
% Pc = Pc';
% mdot = mdot';